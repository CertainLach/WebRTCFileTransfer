"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const xpress_1 = require("/home/f6cf/workspace/dest/xpress");
const xpress_support_ws_1 = require("/home/f6cf/workspace/dest/xpress-support-ws");
const fs_1 = require("/home/f6cf/workspace/dest/fs");
const server = new xpress_1.default('wrft');
xpress_support_ws_1.addSupport(server);
const sockets = {};
server.on('WS /', (req, socket, next) => {
    socket.id = (Math.random() * Number.MAX_SAFE_INTEGER).toString(36);
    console.log('User connected! Id: ' + socket.id);
    sockets[socket.id] = socket;
    console.log('Total connected: ' + Object.keys(sockets).length);
    socket.onmessage = msg => {
        console.log(msg.data);
        if (msg.data === 'is') {
            if (socket.type)
                return socket.close();
            socket.type = 'sender';
            socket.send('us' + socket.id);
        }
        else if (msg.data === 'ic') {
            if (socket.type)
                return socket.close();
            socket.type = 'receiver';
            socket.send('ur');
        }
        else if (msg.data.indexOf('ss') === 0) {
            if (socket.type !== 'receiver')
                return socket.close();
            socket.targetId = msg.data.slice(2);
            if (!sockets[socket.targetId])
                return socket.send('ws');
            if (sockets[socket.targetId].targetId)
                return socket.send('bs');
            sockets[socket.targetId].targetId = socket.id;
            sockets[socket.targetId].send('rf');
            socket.send('sf');
        }
        else if (msg.data.indexOf('gc') === 0) {
            if (!socket.type)
                return socket.close();
            socket.candidate = msg.data.slice(2);
            if (socket.candidate === 'null')
                return;
            if (!socket.targetId)
                return socket.close();
            sockets[socket.targetId].send('gc' + socket.candidate);
        }
        else if (msg.data.indexOf('sdp') === 0) {
            if (socket.type !== 'sender')
                return socket.close();
            socket.sdp = msg.data.slice(3);
            if (!socket.targetId)
                return socket.close();
            sockets[socket.targetId].send('sdp' + socket.sdp);
        }
        else if (msg.data.indexOf('cdp') === 0) {
            if (socket.type !== 'receiver')
                return socket.close();
            socket.cdp = msg.data.slice(3);
            if (!socket.targetId)
                return socket.close();
            sockets[socket.targetId].send('cdp' + socket.cdp);
        }
        else if (msg.data.indexOf('gdc') === 0) {
            if (socket.type !== 'receiver')
                return socket.close();
            if (!socket.targetId)
                return socket.close();
            sockets[socket.targetId].send('gdc');
        }
        else if (msg.data.indexOf('fs') === 0) {
            if (socket.type !== 'sender')
                return socket.close();
            if (!socket.targetId)
                return socket.close();
            sockets[socket.targetId].send(msg.data);
        }
    };
    socket.onclose = () => {
        console.log('User disconnected! Id: ' + socket.id);
        delete sockets[socket.id];
        console.log('Total connected: ' + Object.keys(sockets).length);
    };
});
server.on('GET /', (req, res, next) => {
    res.set('Content-Type', 'text/html');
    fs_1.getReadStream('./index.html').pipe(res);
});
server.on('ALL /sss', (req, res, next) => {
    console.log(req.query);
    req.on('data', d => console.log(d));
    res.send(123);
});
server.listenHttp('0.0.0.0', 8082);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYlJ0Y0ZpbGVUcmFuc2Zlci9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDhDQUF1QztBQUN2QyxvRUFBd0Q7QUFDeEQsc0NBQTRDO0FBRTVDLE1BQU0sTUFBTSxHQUFDLElBQUksZ0JBQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNoQyw4QkFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBRW5CLE1BQU0sT0FBTyxHQUFDLEVBQUUsQ0FBQztBQUNqQixNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBQyxDQUFDLEdBQUcsRUFBQyxNQUFNLEVBQUMsSUFBSTtJQUM3QixNQUFNLENBQUMsRUFBRSxHQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMvRCxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixHQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM5QyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFDLE1BQU0sQ0FBQztJQUMxQixPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixHQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDN0QsTUFBTSxDQUFDLFNBQVMsR0FBQyxHQUFHO1FBQ2hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLEVBQUUsQ0FBQSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUcsSUFBSSxDQUFDLENBQUEsQ0FBQztZQUNoQixFQUFFLENBQUEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO2dCQUFBLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDckMsTUFBTSxDQUFDLElBQUksR0FBQyxRQUFRLENBQUM7WUFDckIsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2hDLENBQUM7UUFBQSxJQUFJLENBQUMsRUFBRSxDQUFBLENBQUMsR0FBRyxDQUFDLElBQUksS0FBRyxJQUFJLENBQUMsQ0FBQSxDQUFDO1lBQ3RCLEVBQUUsQ0FBQSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7Z0JBQUEsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNyQyxNQUFNLENBQUMsSUFBSSxHQUFDLFVBQVUsQ0FBQztZQUN2QixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLENBQUM7UUFBQSxJQUFJLENBQUMsRUFBRSxDQUFBLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUcsQ0FBQyxDQUFDLENBQUEsQ0FBQztZQUNqQyxFQUFFLENBQUEsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFHLFVBQVUsQ0FBQztnQkFBQSxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2xELE1BQU0sQ0FBQyxRQUFRLEdBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEMsRUFBRSxDQUFBLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUFBLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3RELEVBQUUsQ0FBQSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDO2dCQUFBLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlELE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxHQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDNUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QixDQUFDO1FBQUEsSUFBSSxDQUFDLEVBQUUsQ0FBQSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFHLENBQUMsQ0FBQyxDQUFBLENBQUM7WUFDakMsRUFBRSxDQUFBLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO2dCQUFBLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDdEMsTUFBTSxDQUFDLFNBQVMsR0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQyxFQUFFLENBQUEsQ0FBQyxNQUFNLENBQUMsU0FBUyxLQUFHLE1BQU0sQ0FBQztnQkFBQSxNQUFNLENBQUM7WUFDcEMsRUFBRSxDQUFBLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO2dCQUFBLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDMUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBQUEsSUFBSSxDQUFDLEVBQUUsQ0FBQSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFHLENBQUMsQ0FBQyxDQUFBLENBQUM7WUFDbEMsRUFBRSxDQUFBLENBQUMsTUFBTSxDQUFDLElBQUksS0FBRyxRQUFRLENBQUM7Z0JBQUEsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNoRCxNQUFNLENBQUMsR0FBRyxHQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLEVBQUUsQ0FBQSxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztnQkFBQSxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssRUFB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Q0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZCLEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFDLENBQUMsSUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFDLElBQUksQ0FBQyxDQUFDIiwiZmlsZSI6IndlYlJ0Y0ZpbGVUcmFuc2Zlci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBYUHJlc3MgZnJvbSAnQG1ldGVvci1pdC94cHJlc3MnO1xuaW1wb3J0IHthZGRTdXBwb3J0fSBmcm9tICdAbWV0ZW9yLWl0L3hwcmVzcy1zdXBwb3J0LXdzJztcbmltcG9ydCB7Z2V0UmVhZFN0cmVhbX0gZnJvbSAnQG1ldGVvci1pdC9mcyc7XG5cbmNvbnN0IHNlcnZlcj1uZXcgWFByZXNzKCd3cmZ0Jyk7XG5hZGRTdXBwb3J0KHNlcnZlcik7XG5cbmNvbnN0IHNvY2tldHM9e307XG5zZXJ2ZXIub24oJ1dTIC8nLChyZXEsc29ja2V0LG5leHQpPT57XG4gICAgc29ja2V0LmlkPShNYXRoLnJhbmRvbSgpKk51bWJlci5NQVhfU0FGRV9JTlRFR0VSKS50b1N0cmluZygzNik7XG4gICAgY29uc29sZS5sb2coJ1VzZXIgY29ubmVjdGVkISBJZDogJytzb2NrZXQuaWQpO1xuICAgIHNvY2tldHNbc29ja2V0LmlkXT1zb2NrZXQ7XG4gICAgY29uc29sZS5sb2coJ1RvdGFsIGNvbm5lY3RlZDogJytPYmplY3Qua2V5cyhzb2NrZXRzKS5sZW5ndGgpO1xuICAgIHNvY2tldC5vbm1lc3NhZ2U9bXNnPT57XG4gICAgICAgIGNvbnNvbGUubG9nKG1zZy5kYXRhKTtcbiAgICAgICAgaWYobXNnLmRhdGE9PT0naXMnKXtcbiAgICAgICAgICAgIGlmKHNvY2tldC50eXBlKXJldHVybiBzb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgICAgIHNvY2tldC50eXBlPSdzZW5kZXInO1xuICAgICAgICAgICAgc29ja2V0LnNlbmQoJ3VzJytzb2NrZXQuaWQpO1xuICAgICAgICB9ZWxzZSBpZihtc2cuZGF0YT09PSdpYycpe1xuICAgICAgICAgICAgaWYoc29ja2V0LnR5cGUpcmV0dXJuIHNvY2tldC5jbG9zZSgpO1xuICAgICAgICAgICAgc29ja2V0LnR5cGU9J3JlY2VpdmVyJztcbiAgICAgICAgICAgIHNvY2tldC5zZW5kKCd1cicpO1xuICAgICAgICB9ZWxzZSBpZihtc2cuZGF0YS5pbmRleE9mKCdzcycpPT09MCl7XG4gICAgICAgICAgICBpZihzb2NrZXQudHlwZSE9PSdyZWNlaXZlcicpcmV0dXJuIHNvY2tldC5jbG9zZSgpO1xuICAgICAgICAgICAgc29ja2V0LnRhcmdldElkPW1zZy5kYXRhLnNsaWNlKDIpO1xuICAgICAgICAgICAgaWYoIXNvY2tldHNbc29ja2V0LnRhcmdldElkXSlyZXR1cm4gc29ja2V0LnNlbmQoJ3dzJyk7XG4gICAgICAgICAgICBpZihzb2NrZXRzW3NvY2tldC50YXJnZXRJZF0udGFyZ2V0SWQpcmV0dXJuIHNvY2tldC5zZW5kKCdicycpO1xuICAgICAgICAgICAgc29ja2V0c1tzb2NrZXQudGFyZ2V0SWRdLnRhcmdldElkPXNvY2tldC5pZDtcbiAgICAgICAgICAgIHNvY2tldHNbc29ja2V0LnRhcmdldElkXS5zZW5kKCdyZicpO1xuICAgICAgICAgICAgc29ja2V0LnNlbmQoJ3NmJyk7XG4gICAgICAgIH1lbHNlIGlmKG1zZy5kYXRhLmluZGV4T2YoJ2djJyk9PT0wKXtcbiAgICAgICAgICAgIGlmKCFzb2NrZXQudHlwZSlyZXR1cm4gc29ja2V0LmNsb3NlKCk7XG4gICAgICAgICAgICBzb2NrZXQuY2FuZGlkYXRlPW1zZy5kYXRhLnNsaWNlKDIpO1xuICAgICAgICAgICAgaWYoc29ja2V0LmNhbmRpZGF0ZT09PSdudWxsJylyZXR1cm47XG4gICAgICAgICAgICBpZighc29ja2V0LnRhcmdldElkKXJldHVybiBzb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgICAgIHNvY2tldHNbc29ja2V0LnRhcmdldElkXS5zZW5kKCdnYycrc29ja2V0LmNhbmRpZGF0ZSk7XG4gICAgICAgIH1lbHNlIGlmKG1zZy5kYXRhLmluZGV4T2YoJ3NkcCcpPT09MCl7XG4gICAgICAgICAgICBpZihzb2NrZXQudHlwZSE9PSdzZW5kZXInKXJldHVybiBzb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgICAgIHNvY2tldC5zZHA9bXNnLmRhdGEuc2xpY2UoMyk7XG4gICAgICAgICAgICBpZighc29ja2V0LnRhcmdldElkKXJldHVybiBzb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgICAgIHNvY2tldHNbc29ja2V0LnRhcmdldElkXS5zZW5kKCdzZHAnK3NvY2tldC5zZHApO1xuICAgICAgICB9ZWxzZSBpZihtc2cuZGF0YS5pbmRleE9mKCdjZHAnKT09PTApe1xuICAgICAgICAgICAgaWYoc29ja2V0LnR5cGUhPT0ncmVjZWl2ZXInKXJldHVybiBzb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgICAgIHNvY2tldC5jZHA9bXNnLmRhdGEuc2xpY2UoMyk7XG4gICAgICAgICAgICBpZighc29ja2V0LnRhcmdldElkKXJldHVybiBzb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgICAgIHNvY2tldHNbc29ja2V0LnRhcmdldElkXS5zZW5kKCdjZHAnK3NvY2tldC5jZHApO1xuICAgICAgICB9ZWxzZSBpZihtc2cuZGF0YS5pbmRleE9mKCdnZGMnKT09PTApe1xuICAgICAgICAgICAgaWYoc29ja2V0LnR5cGUhPT0ncmVjZWl2ZXInKXJldHVybiBzb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgICAgIGlmKCFzb2NrZXQudGFyZ2V0SWQpcmV0dXJuIHNvY2tldC5jbG9zZSgpO1xuICAgICAgICAgICAgc29ja2V0c1tzb2NrZXQudGFyZ2V0SWRdLnNlbmQoJ2dkYycpO1xuICAgICAgICB9ZWxzZSBpZihtc2cuZGF0YS5pbmRleE9mKCdmcycpPT09MCl7XG4gICAgICAgICAgICBpZihzb2NrZXQudHlwZSE9PSdzZW5kZXInKXJldHVybiBzb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgICAgIGlmKCFzb2NrZXQudGFyZ2V0SWQpcmV0dXJuIHNvY2tldC5jbG9zZSgpO1xuICAgICAgICAgICAgc29ja2V0c1tzb2NrZXQudGFyZ2V0SWRdLnNlbmQobXNnLmRhdGEpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBzb2NrZXQub25jbG9zZT0oKT0+e1xuICAgICAgICBjb25zb2xlLmxvZygnVXNlciBkaXNjb25uZWN0ZWQhIElkOiAnK3NvY2tldC5pZCk7XG4gICAgICAgIGRlbGV0ZSBzb2NrZXRzW3NvY2tldC5pZF07XG4gICAgICAgIGNvbnNvbGUubG9nKCdUb3RhbCBjb25uZWN0ZWQ6ICcrT2JqZWN0LmtleXMoc29ja2V0cykubGVuZ3RoKTtcbiAgICB9O1xufSk7XG5cbnNlcnZlci5vbignR0VUIC8nLChyZXEscmVzLG5leHQpPT57XG4gICAgcmVzLnNldCgnQ29udGVudC1UeXBlJywndGV4dC9odG1sJyk7XG4gICAgZ2V0UmVhZFN0cmVhbSgnLi9pbmRleC5odG1sJykucGlwZShyZXMpO1xufSk7XG5cbnNlcnZlci5vbignQUxMIC9zc3MnLChyZXEscmVzLG5leHQpPT57XG4gICAgY29uc29sZS5sb2cocmVxLnF1ZXJ5KTtcbiAgICByZXEub24oJ2RhdGEnLGQ9PmNvbnNvbGUubG9nKGQpKTtcbiAgICByZXMuc2VuZCgxMjMpO1xufSk7XG5cbnNlcnZlci5saXN0ZW5IdHRwKCcwLjAuMC4wJyw4MDgyKTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
